[;]
[; Parser]
[;]
[define [nextc] [set c [getch]]]
[nextc]
[define
    [getnext]
    [locals result elem quote]
    [set result [array]]
    [while [string_contains ' \n\r\t' c] [nextc]]
    [cond
        [[eq? c '[']
            [nextc]
            [set elem [getnext]]
            [while [not [eq? elem false]] [array_push result elem] [set elem [getnext]]]
            [return result]]
        [[eq? c ']'] [nextc] [return false]]
        [[eq? c '\'']
            [nextc]
            [while
                [not [eq? c '\'']]
                [cond
                    [[eq? c '\\']
                        [nextc]
                        [cond [[eq? c 'n'] [set c '\n']] [[eq? c 'r'] [set c '\r']] [[eq? c 't'] [set c '\t']]]]]
                [array_push result c]
                [nextc]]
            [nextc]
            [return [array 'str' [array_join result '']]]]
        [[string_contains '0123456789' c]
            [while [string_contains '0123456789' c] [array_push result c] [nextc]]
            [return [array 'num' [array_join result '']]]]
        [else
            [while [not [string_contains ' \n\r\t[]' c]] [array_push result c] [nextc]]
            [return [array_join result '']]]]]
[;]
[; Compiler]
[;]
[define [infix name expr] [return [strjoin [compile [get expr 1]] name [compile [get expr 2]]]]]
[define [tailblock expr n] [return [strjoin '{' [array_join [map compile [tail expr n]] ';'] '}']]]
[define
    [compile expr]
    [locals type]
    [set type [get expr 0]]
    [; print [uneval expr]]
    [cond
        [[eq? [typeof expr] 'string'] [return expr]]
        [[eq? type 'define']
            [return
                [strjoin
                    'function '
                    [get [get expr 1] 0]
                    '('
                    [array_join [tail [get expr 1]] ',']
                    ')'
                    [tailblock expr 2]]]]
        [[eq? type 'locals'] [return [strjoin 'var ' [array_join [tail expr] ',']]]]
        [[eq? type 'set'] [return [infix '=' expr]]]
        [[eq? type 'num'] [return [get expr 1]]]
        [[eq? type ';'] [return '']]
        [[eq? type 'get'] [return [strjoin [compile [get expr 1]] '[' [compile [get expr 2]] ']']]]
        [[eq? type 'not'] [return [strjoin '!(' [compile [get expr 1]] ')']]]
        [[eq? type 'eq?'] [return [infix '===' expr]]]
        [[eq? type 'while'] [return [strjoin 'while(' [compile [get expr 1]] ')' [tailblock expr 2]]]]
        [else [return [strjoin type '(' [map compile [tail expr]] ')']]]]]
[;]
[; Main loop]
[;]
[set expr [getnext]]
[while [not [eq? expr false]] [print [listpp expr]] [; print [compile expr]] [set expr [getnext]]]
